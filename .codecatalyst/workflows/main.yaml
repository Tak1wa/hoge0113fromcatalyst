Name: main
SchemaVersion: "1.0"
Triggers:
  - Type: PUSH
    Branches:
      - main
Actions:
  Build_And_Test:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        IncludePaths:
          - "**/TestResults/*"
        ReportNamePrefix: AutoDiscovered
        Enabled: true
    Configuration:
      Steps:
        - Run: dotnet build ServerlessApp.sln -c Release
        - Run: dotnet test ServerlessApp.sln -c Release --no-build --logger "trx"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
  Deploy_To_AWS:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        ReportNamePrefix: AutoDiscovered
        Enabled: false
    Configuration:
      Steps:
        - Run: yum -y install zip
        - Run: dotnet tool install Amazon.Lambda.Tools --global --version 5.*
        - Run: cd src/ServerlessApp
        - Run: dotnet lambda deploy-serverless  --region us-west-2 --resolve-s3 true --stack-name serverless-stack-7ehkt
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Environment:
      Name: default_environment
      Connections:
        - Name: "550669467088"
          Role: CodeCatalystPreviewDevelopmentAdministrator-yjwhxs
    DependsOn:
      - Build_And_Test
